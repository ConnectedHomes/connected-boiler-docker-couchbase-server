---
default:
  couchbase: &couchbase
    image: couchbase-server-new
    ec2_public_hostname: true
    announce:
      couchbase: 8091
    env_vars:
      SET_EC2_HOSTNAME: true
    role: db
    stop_timeout: 60
    expose:
      - 4369:4369
      - 8091:8091
      - 8092:8092
      - 11209:11209
      - 11210:11210
      - 11211:11211
      - from: 21100
        to: 21199

  couchbase-cluster-init: &couchbase-cluster-init
    global_unit: true
    role: db
    wrap_in_shell: true # need this to enable $ETCDCTL_PEERS to be interpolated
    restart_on_failure: true
    env_vars:
      CB_INIT_RAM_SIZE: 512
      CB_INIT_BUCKET_REPLICA_COUNT: 1 
      ETCDCTL_PEERS: $ETCDCTL_PEERS
    docker_links:
      - couchbase

dev:
  couchbase:
    <<: *couchbase
  couchbase-cluster-init:
    <<: *couchbase-cluster-init
  couchbase-backup:
      docker_links:
        - couchbase
      timer: "23:00:00"
      oneshot: true
      ebs:
        vol_id: vol-5c356f5b
        zone: eu-west-1c
        mount: /backups
        device: /dev/xvdm

prod:
  couchbase.1:
    <<: *couchbase
    machine_id: e0cab294db194c2a8958900143410046
    volumes:
      - /couchbase:/opt/couchbase/var
  couchbase.2:
    <<: *couchbase
    ebs:
      vol_id: vol-8a98c28d # eu-west-1c
      mount: /opt/couchbase/var
      device: /dev/xvdg
      machine_id: 6a5ebc4ba97343a687219b6d94b91ce0 
  couchbase.3:
    <<: *couchbase
    ebs:
      vol_id: vol-fcd6eef7 # eu-west-1a
      mount: /opt/couchbase/var
      device: /dev/xvdg
      machine_id: 0c9d1fc6fd1d452eb5b32ac1b6427c8f
  couchbase.4:
    <<: *couchbase
    machine_id: d8f16fa9692f4090bc3812e24ad389fa
    volumes:
      - /couchbase:/opt/couchbase/var
  couchbase.5:
    <<: *couchbase
    machine_id: 19baa1ea2a444211b2cdbd650151c377
    volumes:
      - /couchbase:/opt/couchbase/var
  couchbase.6:
    <<: *couchbase
    machine_id: 1b699d79ccfe4883994960bde6389623
    volumes:
      - /couchbase:/opt/couchbase/var
  couchbase-backup:
      timer: "weekly"
      oneshot: true
      ebs:
        vol_id: vol-574c425c
        zone: eu-west-1a
        machine_id: 0c9d1fc6fd1d452eb5b32ac1b6427c8f 
        mount: /backups
        device: /dev/xvdm
