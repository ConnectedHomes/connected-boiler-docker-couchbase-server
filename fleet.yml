---
default:
  couchbase: &couchbase
    image: couchbase-server-new
    announce:
      couchbase: 8091
    env_vars:
      SET_EC2_HOSTNAME: true
    global_unit: true
    role: db
    expose:
      - 4369:4369
      - 8091:8091
      - 8092:8092
      - 11209:11209
      - 11210:11210
      - 11211:11211
      - from: 21100
        to: 21199
    volumes: 
      - /couchbase:/opt/couchbase/var

  couchbase-cluster-init: &couchbase-cluster-init
    global_unit: true
    role: db
    wrap_in_shell: true # need this to enable $ETCDCTL_PEERS to be interpolated
    restart_on_failure: true
    env_vars:
      CB_INIT_RAM_SIZE: 512
      ETCDCTL_PEERS: $ETCDCTL_PEERS
    docker_links:
      - couchbase

dev:
  couchbase:
    <<: *couchbase
  couchbase-cluster-init:
    <<: *couchbase-cluster-init

prod:
  couchbase:
    <<: *couchbase
    ebs:
      vol_id: vol-6ab6f76d
      zone: eu-west-1c
      mount: /opt/couchbase/var
      device: /dev/xvdg
      conflicts:
        - bosch*
        - redis*
        - nhs*
        - d2*
        - cc*
        - api*

  couchbase-backup:
    docker_links:
      - couchbase
    timer: "01:00:00"
    oneshot: true
    ebs:
      vol_id: vol-3f104338
      zone: eu-west-1c
      mount: /backups
      device: /dev/xvdm
